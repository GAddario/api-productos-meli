name: CD

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: [self-hosted, Windows]   # Runner self-hosted en Windows
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Docker Compose down & up
        run: |
          docker compose down
          docker compose up -d --build
          docker image prune -f

      - name: Esperar health (PowerShell)
        run: |
          Write-Host "Esperando health=200..."
          $ok = $false
          for ($i=1; $i -le 20; $i++) {
            try {
              $res = Invoke-WebRequest -UseBasicParsing -Uri http://localhost:5000/health -TimeoutSec 5
              if ($res.StatusCode -eq 200) { $ok = $true; break }
            } catch { }
            Write-Host "Intento $i/20 - esperando 3s..."
            Start-Sleep -Seconds 3
          }
          if (-not $ok) { Write-Error "❌ No quedó healthy"; exit 1 } else { Write-Host "✅ Health OK" }
